<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Visualisation B√¢timents</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100 font-sans">

  <div class="container mx-auto p-8">
    <h1 class="text-3xl font-bold text-center mb-6 text-blue-700">üèóÔ∏è R√©gularisation des B√¢timents</h1>

    <!-- Formulaire Upload -->
    <form id="uploadForm" enctype="multipart/form-data"
          class="flex flex-col items-center gap-4 bg-white p-6 rounded-xl shadow-md mb-6">
      <label class="font-semibold text-gray-700">Choisissez un fichier (GeoJSON, GPKG, Shapefile .zip)</label>
      <input type="file" name="file" id="fileInput"
             class="border p-2 rounded-md w-full max-w-md bg-gray-50">
      <button type="submit"
              class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">
        G√©n√©rer la carte
      </button>
    </form>

    <p id="speed" class="text-center text-lg text-green-600 mb-4 hidden"></p>

    <!-- Carte -->
    <div id="map"></div>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileInput");
    const speedText = document.getElementById("speed");

    // Init carte
    const map = L.map("map").setView([1, 1], 2);

    // Couches fonds
    const satelliteLayer = L.tileLayer(
      "https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",
      { maxZoom: 100, attribution: "¬© Google Satellite" }
    ).addTo(map);

    const osmLayer = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxZoom: 100, attribution: "¬© OpenStreetMap" }
    );

    const baseMaps = {
      "Satellite": satelliteLayer,
      "OpenStreetMap": osmLayer
    };
    L.control.layers(baseMaps).addTo(map);

    let originalLayer, regularizedLayer;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      const res = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      const data = await res.json();

      // Afficher vitesse
      speedText.textContent = "‚úÖ Vitesse de traitement : " + data.speed;
      speedText.classList.remove("hidden");

      // Supprimer
      if (originalLayer) map.removeLayer(originalLayer);
      if (regularizedLayer) map.removeLayer(regularizedLayer);

      //
      const originalGeojson = JSON.parse(data.original);
      const regularizedGeojson = JSON.parse(data.regularized);

      // Ajouter couches
      originalLayer = L.geoJSON(originalGeojson, {
        style: { color: "white", weight: 2, fillOpacity: 0.1 }
      }).addTo(map);

      regularizedLayer = L.geoJSON(regularizedGeojson, {
        style: { color: "blue", fillColor: "red", weight: 2, fillOpacity: 0.4 }
      }).addTo(map);

      // Adapter le zoom
      map.fitBounds(originalLayer.getBounds());
    });
  </script>

</body>
</html>